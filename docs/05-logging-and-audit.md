# 05 - Logging & Auditing

AgenticOS is designed with auditability as a core principle. Every significant action performed by an agent or router is meticulously recorded in machine-readable JSON logs. This ensures transparency, traceability, and the ability to review past operations for compliance, debugging, or understanding system behavior.

---

## 1. Log Location

All execution logs generated by `scripts/agent` and `scripts/router` are stored in a dedicated directory:

```text
.agents/logs/*.json
```

Each log file is named with a timestamp and the profile/action, for example: `YYYY-MM-DDTHH-MM-SSZ-<profile_or_action>.json`.

## 2. Key Fields in Agent Logs (`scripts/agent`)

Logs generated by `scripts/agent` capture a detailed snapshot of each agent session.

*   `timestamp_start`, `timestamp_end`: UTC timestamps marking the beginning and end of the session.
*   `profile`: The name of the agent profile executed (e.g., `dev`, `ops`).
*   `provider`: The underlying LLM provider used (e.g., `codex`, `claude`).
*   `prompt`: The full path to the prompt file used by the agent.
*   `command`: The exact command string executed for the underlying CLI (e.g., `codex exec ...`).
*   `argv`: The command broken down into arguments.
*   `cwd`: The current working directory where the command was executed.
*   `exit_code`: The exit code of the underlying CLI command (or `timeout`, `interrupt`).
*   `stdout`, `stderr`: Normalized standard output and error from the underlying CLI.
*   `stdout_raw`, `stderr_raw`: Raw standard output and error from the underlying CLI.
*   `stdout_norm`, `stderr_norm`: Normalized versions of stdout/stderr, after processing by AgenticOS.
*   `provider_meta`: Metadata extracted from the provider's output (e.g., session ID, model, workdir).
*   `normalization_notes`: Notes about any normalization applied to the output (e.g., banner stripping).
*   `extra_args`: Additional arguments passed to the underlying CLI.
*   `timeout_seconds`: The configured timeout for the command.
*   `memory_file`: The path to the memory file used for the session.
*   `memory_preview`: A truncated preview of the memory file content.
*   `sections`: Structured sections extracted from the agent's output (Plan, Code Changes, etc.).
*   `next_actions`: Inferred next actions from the agent's output.
*   `delta`: A computed summary of changes from the previous session (e.g., "Summary updated.").
*   `tags`: Custom tags attached to the session (e.g., `security`, `bug-fix`).
*   `cli_version_note`: Version information about the underlying CLI.
*   `workflow_name`: The name of the workflow if executed within a workflow context (from `WORKFLOW` env var).
*   `workflow_step`: The current step in the workflow (from `WORKFLOW_STEP` env var).
*   `workflow_context_injected`: Boolean indicating if workflow context was added to the prompt.

### Example Agent Log (`scripts/agent`)

```json
{
  "timestamp_start": "...",
  "timestamp_end": "...",
  "profile": "dev",
  "provider": "codex",
  "prompt": "/path/to/dev.md",
  "command": "codex exec --skip-git-repo-check - --profile dev",
  "exit_code": 0,
  "stdout": "...",
  "stderr": "",
  "delta": ["- Next actions refreshed."],
  "tags": ["profile:dev", "provider:codex", "memory:on"],
  "workflow_name": "auto_fix_bug",
  "workflow_step": "implement",
  "...": "..."
}
```

---

## 3. Key Fields in Router Logs (`scripts/router`)

Logs generated by `scripts/router` focus on the routing decision itself.

*   `router_action`: The router command executed (`list`, `run`, `auto`).
*   `target_type`: The type of target (`profile` or `workflow`).
*   `target_name`: The name of the routed profile or workflow.
*   `argv`: The arguments passed to the router command.
*   `exit_code`: The exit code of the router command.
*   `duration_ms`: Execution duration of the router action.
*   `underlying_log`: Path to the log file generated by the underlying agent/workflow.
*   `timestamp`: UTC timestamp of the router action.
*   `cwd`: Current working directory.

### Example Router Log (`scripts/router`)

```json
{
  "router_action": "auto",
  "target_type": "workflow",
  "target_name": "auto_fix_bug",
  "argv": ["./scripts/router", "auto", "--task", "fix"],
  "exit_code": 0,
  "duration_ms": 123,
  "underlying_log": ".agents/logs/YYYY-MM-DDTHH-MM-SSZ-dev.json",
  "timestamp": "...",
  "...": "..."
}
```

---

## 4. Log Schema Conformance and Validation

AgenticOS logs adhere to a defined schema to ensure consistency and machine readability.

*   **Schema Location:** The canonical log schema for validation is located at:
    ```text
    .agents/schemas/log_v1.json
    ```
*   **`scripts/doctor` Validation:** The `scripts/doctor` tool includes checks to ensure that the latest log entries conform to this schema.
    *   It checks for the presence of `required` fields (`stdout_norm`, `stderr_norm`, `provider_meta`, `normalization_notes`).
    *   It also checks for `optional` fields (`sections`, `next_actions`, `delta`, `delta_sources`, `tags`, `run_id`).
    *   If the `jsonschema` Python library is installed and `log_v1.json` exists, `doctor` will perform a full JSON schema validation.
*   **Audit-Grade:** The consistent structure and validation of logs make them suitable for automated auditing and analysis, allowing for the tracking of every decision and outcome within AgenticOS.
